/**
 * @license ng-alain(cipchk@qq.com) v2.0.0-beta.5
 * (c) 2018 Cipchk https://ng-alain.com/
 * License: MIT
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@angular/core"),require("@angular/common/http"),require("date-fns/add_seconds"),require("rxjs"),require("rxjs/operators")):"function"==typeof define&&define.amd?define("@delon/cache",["exports","@angular/core","@angular/common/http","date-fns/add_seconds","rxjs","rxjs/operators"],e):e((t.delon=t.delon||{},t.delon.cache={}),t.ng.core,t.ng.common.http,t.addSeconds,t.rxjs,t.rxjs.operators)}(this,function(t,e,o,n,s,f){"use strict";n=n&&n.hasOwnProperty("default")?n["default"]:n;var r=new e.InjectionToken("DC_STORE_STORAGE_TOKEN"),i=function h(){this.mode="promise",this.reName="",this.prefix="",this.meta_key="__cache_meta"},a=function(){function t(t,e,o){this.options=t,this.store=e,this.http=o,this.memory=new Map,this.notifyBuffer=new Map,this.meta=new Set,this.freq_tick=3e3,this.loadMeta(),this.startExpireNotify()}return t.prototype._deepGet=function(t,e,o){if(!t)return o;if(e.length<=1){var r=e.length?t[e[0]]:t;return void 0===r?o:r}return e.reduce(function(t,e){return t[e]},t)||o},t.prototype.pushMeta=function(t){this.meta.has(t)||(this.meta.add(t),this.saveMeta())},t.prototype.removeMeta=function(t){this.meta.has(t)&&(this.meta["delete"](t),this.saveMeta())},t.prototype.loadMeta=function(){var e=this,t=this.store.get(this.options.meta_key);t&&t.v&&t.v.forEach(function(t){return e.meta.add(t)})},t.prototype.saveMeta=function(){var e=[];this.meta.forEach(function(t){return e.push(t)}),this.store.set(this.options.meta_key,{v:e,e:0})},t.prototype.getMeta=function(){return this.meta},t.prototype.set=function(e,t,o){var r=this;void 0===o&&(o={});var i=0;if(o.expire&&(i=n(new Date,o.expire).valueOf()),t instanceof s.Observable)return t.pipe(f.tap(function(t){r.save(o.type,e,{v:t,e:i})}));this.save(o.type,e,{v:t,e:i})},t.prototype.save=function(t,e,o){"m"===t?this.memory.set(e,o):(this.store.set(this.options.prefix+e,o),this.pushMeta(e)),this.runNotify(e,"set")},t.prototype.get=function(e,t){var o=this;void 0===t&&(t={});var r="none"!==t.mode&&"promise"===this.options.mode,i=this.memory.has(e)?this.memory.get(e):this.store.get(this.options.prefix+e);return!i||i.e&&0<i.e&&i.e<(new Date).valueOf()?r?this.http.get(e).pipe(f.map(function(t){return o._deepGet(t,o.options.reName,null)}),f.tap(function(t){return o.set(e,t)})):null:r?s.of(i.v):i.v},t.prototype.getNone=function(t){return this.get(t,{mode:"none"})},t.prototype.tryGet=function(t,e,o){void 0===o&&(o={});var r=this.getNone(t);return null===r?e instanceof s.Observable?this.set(t,e,o):(this.set(t,e,o),e):s.of(r)},t.prototype.has=function(t){return this.memory.has(t)||this.meta.has(t)},t.prototype._remove=function(t,e){e&&this.runNotify(t,"remove"),this.memory.has(t)?this.memory["delete"](t):(this.store.remove(this.options.prefix+t),this.removeMeta(t))},t.prototype.remove=function(t){this._remove(t,!0)},t.prototype.clear=function(){var o=this;this.notifyBuffer.forEach(function(t,e){return o.runNotify(e,"remove")}),this.memory.clear(),this.meta.forEach(function(t){return o.store.remove(o.options.prefix+t)})},Object.defineProperty(t.prototype,"freq",{set:function(t){this.freq_tick=Math.max(20,t),this.abortExpireNotify(),this.startExpireNotify()},enumerable:!0,configurable:!0}),t.prototype.startExpireNotify=function(){this.checkExpireNotify(),this.runExpireNotify()},t.prototype.runExpireNotify=function(){var t=this;this.freq_time=setTimeout(function(){t.checkExpireNotify(),t.runExpireNotify()},this.freq_tick)},t.prototype.checkExpireNotify=function(){var o=this,r=[];this.notifyBuffer.forEach(function(t,e){o.has(e)&&null===o.getNone(e)&&r.push(e)}),r.forEach(function(t){o.runNotify(t,"expire"),o._remove(t,!1)})},t.prototype.abortExpireNotify=function(){clearTimeout(this.freq_time)},t.prototype.runNotify=function(t,e){this.notifyBuffer.has(t)&&this.notifyBuffer.get(t).next({type:e,value:this.getNone(t)})},t.prototype.notify=function(t){if(!this.notifyBuffer.has(t)){var e=new s.BehaviorSubject(this.getNone(t));this.notifyBuffer.set(t,e)}return this.notifyBuffer.get(t).asObservable()},t.prototype.cancelNotify=function(t){this.notifyBuffer.has(t)&&(this.notifyBuffer.get(t).unsubscribe(),this.notifyBuffer["delete"](t))},t.prototype.hasNotify=function(t){return this.notifyBuffer.has(t)},t.prototype.clearNotify=function(){this.notifyBuffer.forEach(function(t){return t.unsubscribe()}),this.notifyBuffer.clear()},t.prototype.ngOnDestroy=function(){this.memory.clear(),this.abortExpireNotify(),this.clearNotify()},t.decorators=[{type:e.Injectable}],t.ctorParameters=function(){return[{type:i},{type:undefined,decorators:[{type:e.Inject,args:[r]}]},{type:o.HttpClient}]},t}(),u=function(){function t(){}return t.prototype.get=function(t){return JSON.parse(localStorage.getItem(t)||"null")||null},t.prototype.set=function(t,e){return localStorage.setItem(t,JSON.stringify(e)),!0},t.prototype.remove=function(t){localStorage.removeItem(t)},t}(),p=function(){function t(){}return t.forRoot=function(){return{ngModule:t,providers:[i,a,{provide:r,useClass:u}]}},t.decorators=[{type:e.NgModule,args:[{}]}],t}();t.DC_STORE_STORAGE_TOKEN=r,t.CacheService=a,t.DelonCacheConfig=i,t.DelonCacheModule=p,t.Éµa=u,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=cache.umd.min.js.map