/**
 * @license ng-alain(cipchk@qq.com) v9.0.0-rc.2
 * (c) 2019 cipchk https://ng-alain.com/
 * License: MIT
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/common"),require("@angular/core"),require("@angular/router"),require("rxjs"),require("rxjs/operators"),require("@angular/common/http")):"function"==typeof define&&define.amd?define("@delon/auth",["exports","@angular/common","@angular/core","@angular/router","rxjs","rxjs/operators","@angular/common/http"],t):t(((e=e||self).delon=e.delon||{},e.delon.auth={}),e.ng.common,e.ng.core,e.ng.router,e.rxjs,e.rxjs.operators,e.ng.common.http)}(this,(function(e,t,r,n,o,i,a){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */var s=function(e,t){return(s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};function c(e,t){function r(){this.constructor=e}s(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}var u=function(){return(u=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};function l(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}var p=function(){function e(){this.store_key="_token",this.token_invalid_redirect=!0,this.token_exp_offset=10,this.token_send_key="token",this.token_send_template="${token}",this.token_send_place="header",this.login_url="/login",this.ignores=[/\/login/,/assets\//,/passport\//],this.allow_anonymous_key="_allow_anonymous",this.executeOtherInterceptors=!0}return e.decorators=[{type:r.Injectable,args:[{providedIn:"root"}]}],e.ɵprov=r.ɵɵdefineInjectable({factory:function(){return new e},token:e,providedIn:"root"}),e}();function h(){return new f}var f=function(){function e(){}return e.prototype.get=function(e){return JSON.parse(localStorage.getItem(e)||"{}")||{}},e.prototype.set=function(e,t){return localStorage.setItem(e,JSON.stringify(t)),!0},e.prototype.remove=function(e){localStorage.removeItem(e)},e}(),d=new r.InjectionToken("AUTH_STORE_TOKEN",{providedIn:"root",factory:h});function y(){return new g(r.inject(p),r.inject(d))}var g=function(){function e(e,t){this.options=e,this.store=t,this.change$=new o.BehaviorSubject(null),this._referrer={}}return Object.defineProperty(e.prototype,"login_url",{get:function(){return this.options.login_url},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"referrer",{get:function(){return this._referrer},enumerable:!0,configurable:!0}),e.prototype.set=function(e){return this.change$.next(e),this.store.set(this.options.store_key,e)},e.prototype.get=function(e){var t=this.store.get(this.options.store_key);return e?Object.assign(new e,t):t},e.prototype.clear=function(e){void 0===e&&(e={onlyToken:!1});var t=null;!0===e.onlyToken?((t=this.get()).token="",this.set(t)):this.store.remove(this.options.store_key),this.change$.next(t)},e.prototype.change=function(){return this.change$.pipe(i.share())},e.ctorParameters=function(){return[{type:p},{type:void 0,decorators:[{type:r.Inject,args:[d]}]}]},e}();var v=new r.InjectionToken("DA_SERVICE_TOKEN",{providedIn:"root",factory:y});var _="_delonAuthSocialType",m="_delonAuthSocialCallbackByHref",w=function(){function e(e,t,r){this.tokenService=e,this.doc=t,this.router=r}return e.prototype.login=function(e,t,r){var n=this;if(void 0===t&&(t="/"),void 0===r&&(r={}),r=u({type:"window",windowFeatures:"location=yes,height=570,width=520,scrollbars=yes,status=yes"},r),localStorage.setItem(_,r.type),localStorage.setItem(m,t),"href"!==r.type)return this._win=window.open(e,"_blank",r.windowFeatures),this._winTime=setInterval((function(){if(n._win&&n._win.closed){n.ngOnDestroy();var e=n.tokenService.get();e&&!e.token&&(e=null),e&&n.tokenService.set(e),n.observer.next(e),n.observer.complete()}}),100),new o.Observable((function(e){n.observer=e}));this.doc.location.href=e},e.prototype.callback=function(e){if(!e&&-1===this.router.url.indexOf("?"))throw new Error("url muse contain a ?");var t={token:""};if("string"==typeof e){var r=e.split("?")[1].split("#")[0];t=this.router.parseUrl("./?"+r).queryParams}else t=e;if(!t||!t.token)throw new Error("invalide token data");this.tokenService.set(t);var n=localStorage.getItem(m)||"/";localStorage.removeItem(m);var o=localStorage.getItem(_);return localStorage.removeItem(_),"window"===o?window.close():this.router.navigateByUrl(n),t},e.prototype.ngOnDestroy=function(){clearInterval(this._winTime),this._winTime=null},e.decorators=[{type:r.Injectable}],e.ctorParameters=function(){return[{type:void 0,decorators:[{type:r.Inject,args:[v]}]},{type:void 0,decorators:[{type:r.Inject,args:[t.DOCUMENT]}]},{type:n.Router}]},e}();var j=function(){function e(){this.cache={}}return e.prototype.get=function(e){return this.cache[e]||{}},e.prototype.set=function(e,t){return this.cache[e]=t,!0},e.prototype.remove=function(e){this.cache[e]=null},e}();var k=function(){function e(){}return e.prototype.get=function(e){return JSON.parse(sessionStorage.getItem(e)||"{}")||{}},e.prototype.set=function(e,t){return sessionStorage.setItem(e,JSON.stringify(t)),!0},e.prototype.remove=function(e){sessionStorage.removeItem(e)},e}();function I(e){return null!=e&&"string"==typeof e.token&&e.token.length>0}function b(e,t){return null!=e&&!!e.token&&!e.isExpired(t)}function S(e,r,o){var i=r.get(n.Router);r.get(v).referrer.url=o||i.url,!0===e.token_invalid_redirect&&setTimeout((function(){/^https?:\/\//g.test(e.login_url)?r.get(t.DOCUMENT).location.href=e.login_url:i.navigate([e.login_url])}))}var O=function(){function e(e,t){this.next=e,this.interceptor=t}return e.prototype.handle=function(e){return this.interceptor.intercept(e,this.next)},e}();var T=function(){function e(e){this.injector=e}return e.prototype.intercept=function(e,t){var r,n,i=u(u({},new p),this.injector.get(p,void 0));if(i.ignores)try{for(var s=l(i.ignores),c=s.next();!c.done;c=s.next()){if(c.value.test(e.url))return t.handle(e)}}catch(e){r={error:e}}finally{try{c&&!c.done&&(n=s.return)&&n.call(s)}finally{if(r)throw r.error}}if(i.allow_anonymous_key&&(e.params.has(i.allow_anonymous_key)||new RegExp("[?|&]"+i.allow_anonymous_key+"=[^&]+").test(e.urlWithParams)))return t.handle(e);if(!this.isAuth(i)){S(i,this.injector);var h=new o.Observable((function(t){var r=new a.HttpErrorResponse({url:e.url,headers:e.headers,status:401,statusText:"来自 @delon/auth 的拦截，所请求URL未授权，若是登录API可加入 [url?_allow_anonymous=true] 来表示忽略校验，更多方法请参考： https://ng-alain.com/auth/getting-started#DelonAuthConfig\nThe interception from @delon/auth, the requested URL is not authorized. If the login API can add [url?_allow_anonymous=true] to ignore the check, please refer to: https://ng-alain.com/auth/getting-started#DelonAuthConfig"});t.error(r)}));if(i.executeOtherInterceptors){var f=this.injector.get(a.HTTP_INTERCEPTORS,[]),d=f.slice(f.indexOf(this)+1);if(d.length>0)return d.reduceRight((function(e,t){return new O(e,t)}),{handle:function(e){return h}}).handle(e)}return h}return e=this.setReq(e,i),t.handle(e)},e.decorators=[{type:r.Injectable}],e.ctorParameters=function(){return[{type:r.Injector,decorators:[{type:r.Optional}]}]},e}();function x(e){var t=e.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw new Error("'atob' failed: The string to be decoded is not correctly encoded.")}return function(e){return decodeURIComponent(Array.prototype.map.call(function(e){var t="";e=String(e).replace(/=+$/,"");for(var r=0,n=void 0,o=void 0,i=0;o=e.charAt(i++);~o&&(n=r%4?64*n+o:o,r++%4)?t+=String.fromCharCode(255&n>>(-2*r&6)):0)o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(o);return t}(e),(function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)})).join(""))}(t)}var E=function(){function e(){}return Object.defineProperty(e.prototype,"payload",{get:function(){var e=(this.token||"").split(".");if(3!==e.length)throw new Error("JWT must have 3 parts");var t=x(e[1]);return JSON.parse(t)},enumerable:!0,configurable:!0}),e.prototype.isExpired=function(e){void 0===e&&(e=0);var t=this.payload;if(!t.hasOwnProperty("exp"))return null;var r=new Date(0);return r.setUTCSeconds(t.exp),!(r.valueOf()>(new Date).valueOf()+1e3*e)},e}();var A=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return c(t,e),t.prototype.isAuth=function(e){return this.model=this.injector.get(v).get(E),b(this.model,e.token_exp_offset)},t.prototype.setReq=function(e,t){return e.clone({setHeaders:{Authorization:"Bearer "+this.model.token}})},t.decorators=[{type:r.Injectable}],t}(T),R=function(){function e(e,t,r){this.srv=e,this.injector=t,this.cog=u(u({},new p),r)}return e.prototype.process=function(){var e=b(this.srv.get(E),this.cog.token_exp_offset);return e||S(this.cog,this.injector,this.url),e},e.prototype.canLoad=function(e,t){return this.url=e.path,this.process()},e.prototype.canActivateChild=function(e,t){return this.url=t.url,this.process()},e.prototype.canActivate=function(e,t){return this.url=t.url,this.process()},e.decorators=[{type:r.Injectable,args:[{providedIn:"root"}]}],e.ctorParameters=function(){return[{type:void 0,decorators:[{type:r.Inject,args:[v]}]},{type:r.Injector},{type:p}]},e.ɵprov=r.ɵɵdefineInjectable({factory:function(){return new e(r.ɵɵinject(v),r.ɵɵinject(r.INJECTOR),r.ɵɵinject(p))},token:e,providedIn:"root"}),e}();var C=function(){};var P=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return c(t,e),t.prototype.isAuth=function(e){return this.model=this.injector.get(v).get(),I(this.model)},t.prototype.setReq=function(e,t){var r=this,n=t.token_send_template,o=t.token_send_key,i=n.replace(/\$\{([\w]+)\}/g,(function(e,t){return r.model[t]}));switch(t.token_send_place){case"header":var a={};a[o]=i,e=e.clone({setHeaders:a});break;case"body":var s=e.body||{};s[o]=i,e=e.clone({body:s});break;case"url":e=e.clone({params:e.params.append(o,i)})}return e},t.decorators=[{type:r.Injectable}],t}(T),N=function(){function e(e,t,r){this.srv=e,this.injector=t,this.cog=u(u({},new p),r)}return e.prototype.process=function(){var e=I(this.srv.get());return e||S(this.cog,this.injector,this.url),e},e.prototype.canLoad=function(e,t){return this.url=e.path,this.process()},e.prototype.canActivateChild=function(e,t){return this.url=t.url,this.process()},e.prototype.canActivate=function(e,t){return this.url=t.url,this.process()},e.decorators=[{type:r.Injectable,args:[{providedIn:"root"}]}],e.ctorParameters=function(){return[{type:void 0,decorators:[{type:r.Inject,args:[v]}]},{type:r.Injector},{type:p}]},e.ɵprov=r.ɵɵdefineInjectable({factory:function(){return new e(r.ɵɵinject(v),r.ɵɵinject(r.INJECTOR),r.ɵɵinject(p))},token:e,providedIn:"root"}),e}();var D=function(){function e(){}return e.decorators=[{type:r.NgModule,args:[{}]}],e}();e.BaseInterceptor=T,e.DA_SERVICE_TOKEN=v,e.DA_SERVICE_TOKEN_FACTORY=y,e.DA_STORE_TOKEN=d,e.DA_STORE_TOKEN_LOCAL_FACTORY=h,e.DelonAuthConfig=p,e.DelonAuthModule=D,e.JWTGuard=R,e.JWTInterceptor=A,e.JWTTokenModel=E,e.LocalStorageStore=f,e.MemoryStore=j,e.SessionStorageStore=k,e.SimpleGuard=N,e.SimpleInterceptor=P,e.SimpleTokenModel=C,e.SocialService=w,e.TokenService=g,e.urlBase64Decode=x,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=auth.umd.min.js.map