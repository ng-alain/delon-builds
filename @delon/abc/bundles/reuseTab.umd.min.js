/**
 * @license ng-alain(cipchk@qq.com) v2.0.0-beta.5
 * (c) 2018 Cipchk https://ng-alain.com/
 * License: MIT
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@delon/theme"),require("@angular/cdk/overlay"),require("@angular/cdk/portal"),require("rxjs"),require("@angular/router"),require("rxjs/operators"),require("@delon/util"),require("@angular/common"),require("ng-zorro-antd")):"function"==typeof define&&define.amd?define("@delon/abc/reuse-tab",["exports","@angular/core","@delon/theme","@angular/cdk/overlay","@angular/cdk/portal","rxjs","@angular/router","rxjs/operators","@delon/util","@angular/common","ng-zorro-antd"],t):t((e.delon=e.delon||{},e.delon.abc=e.delon.abc||{},e.delon.abc["reuse-tab"]={}),e.ng.core,e.delon.theme,e.ng.cdk.overlay,e.ng.cdk.portal,e.rxjs,e.ng.router,e.rxjs.operators,e.delon.util,e.ng.common,e.ngZorro.antd)}(this,function(e,l,t,h,p,d,a,f,n,o,i){"use strict";var g=function(){function e(e){this.i18nSrv=e,this.close=new l.EventEmitter}return Object.defineProperty(e.prototype,"i18n",{get:function(){return this._i18n},set:function(e){this._i18n=Object.assign({},this.i18nSrv.getData("reuseTab"),e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"includeNonCloseable",{get:function(){return this.event.ctrlKey},enumerable:!0,configurable:!0}),e.prototype.notify=function(e,t){this.close.next({type:e,item:this.item,includeNonCloseable:this.includeNonCloseable})},e.prototype.ngOnInit=function(){this.includeNonCloseable&&(this.item.closable=!0)},e.prototype.click=function(e,t){e.preventDefault(),e.stopPropagation(),("close"!==t||this.item.closable)&&("closeRight"===t&&this.item.last||this.notify(t,this.item))},e.prototype.closeMenu=function(e){"click"===e.type&&2===e.button||this.notify(null,null)},e.decorators=[{type:l.Component,args:[{selector:"reuse-tab-context-menu",template:'\n  <ul nz-menu>\n      <li nz-menu-item (click)="click($event, \'close\')" data-type="close" [nzDisabled]="!item.closable" [innerHTML]="i18n.close"></li>\n      <li nz-menu-item (click)="click($event, \'closeOther\')" data-type="closeOther" [innerHTML]="i18n.closeOther"></li>\n      <li nz-menu-item (click)="click($event, \'closeRight\')" data-type="closeRight" [nzDisabled]="item.last" [innerHTML]="i18n.closeRight"></li>\n      <li nz-menu-item (click)="click($event, \'clear\')" data-type="clear" [innerHTML]="i18n.clear"></li>\n  </ul>',preserveWhitespaces:!1}]}],e.ctorParameters=function(){return[{type:t.DelonLocaleService}]},e.propDecorators={i18n:[{type:l.Input}],item:[{type:l.Input}],event:[{type:l.Input}],close:[{type:l.Output}],closeMenu:[{type:l.HostListener,args:["document:click",["$event"]]},{type:l.HostListener,args:["document:contextmenu",["$event"]]}]},e}(),y=function(){return(y=Object.assign||function(e){for(var t,n=1,o=arguments.length;n<o;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)};function r(e,t,n,o){var i,r=arguments.length,s=r<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,n):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,o);else for(var c=e.length-1;0<=c;c--)(i=e[c])&&(s=(r<3?i(s):3<r?i(t,n,s):i(t,n))||s);return 3<r&&s&&Object.defineProperty(t,n,s),s}function s(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}function v(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var o,i,r=n.call(e),s=[];try{for(;(void 0===t||0<t--)&&!(o=r.next()).done;)s.push(o.value)}catch(c){i={error:c}}finally{try{o&&!o.done&&(n=r["return"])&&n.call(r)}finally{if(i)throw i.error}}return s}function c(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(v(arguments[t]));return e}var u=function(){function e(e){this.overlay=e,this.show=new d.Subject,this.close=new d.Subject}return e.prototype.remove=function(){this.ref&&(this.ref.detach(),this.ref.dispose(),this.ref=null)},e.prototype.open=function(e){var t=this;this.remove();var n=e.event,o=e.item,i=new l.ElementRef({getBoundingClientRect:function(){return{bottom:n.clientY,height:0,left:n.clientX,right:n.clientX,top:n.clientY,width:0}}}),r=[new h.ConnectionPositionPair({originX:"start",originY:"bottom"},{overlayX:"start",overlayY:"top"}),new h.ConnectionPositionPair({originX:"start",originY:"top"},{overlayX:"start",overlayY:"bottom"})],s=this.overlay.position().flexibleConnectedTo(i).withPositions(r);this.ref=this.overlay.create({positionStrategy:s,panelClass:"reuse-tab__cm",scrollStrategy:this.overlay.scrollStrategies.close()});var c=this.ref.attach(new p.ComponentPortal(g)),u=c.instance;u.i18n=this.i18n,u.item=y({},o),u.event=n;var a=new d.Subscription;a.add(u.close.subscribe(function(e){t.close.next(e),t.remove()})),c.onDestroy(function(){return a.unsubscribe()})},e.decorators=[{type:l.Injectable}],e.ctorParameters=function(){return[{type:h.Overlay}]},e}(),b=function(){function e(e){var t=this;this.srv=e,this.sub$=new d.Subscription,this.change=new l.EventEmitter,this.sub$.add(e.show.subscribe(function(e){return t.srv.open(e)})),this.sub$.add(e.close.subscribe(function(e){return t.change.emit(e)}))}return Object.defineProperty(e.prototype,"i18n",{set:function(e){this.srv.i18n=e},enumerable:!0,configurable:!0}),e.prototype.ngOnDestroy=function(){this.sub$.unsubscribe()},e.decorators=[{type:l.Component,args:[{selector:"reuse-tab-context",template:"",preserveWhitespaces:!1}]}],e.ctorParameters=function(){return[{type:u}]},e.propDecorators={i18n:[{type:l.Input}],change:[{type:l.Output}]},e}(),m=function(){function e(e){this.srv=e}return e.prototype.onContextMenu=function(e){this.srv.show.next({event:e,item:this.item}),e.preventDefault(),e.stopPropagation()},e.decorators=[{type:l.Directive,args:[{selector:"[reuse-tab-context-menu]"}]}],e.ctorParameters=function(){return[{type:u}]},e.propDecorators={item:[{type:l.Input,args:["reuse-tab-context-menu"]}],onContextMenu:[{type:l.HostListener,args:["contextmenu",["$event"]]}]},e}(),C={Menu:0,MenuForce:1,URL:2};C[C.Menu]="Menu",C[C.MenuForce]="MenuForce",C[C.URL]="URL";var x=function(){function e(e,t){this.injector=e,this.menuService=t,this._max=10,this._debug=!1,this._mode=C.Menu,this._excludes=[],this._cachedChange=new d.BehaviorSubject(null),this._cached=[],this._titleCached={},this._closableCached={}}return Object.defineProperty(e.prototype,"curUrl",{get:function(){return this.getUrl(this.injector.get(a.ActivatedRoute).snapshot)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"max",{set:function(e){this._max=Math.min(Math.max(e,2),100);for(var t=this._cached.length;t>this._max;t--)this._cached.pop()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"mode",{get:function(){return this._mode},set:function(e){this._mode=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"debug",{get:function(){return this._debug},set:function(e){this._debug=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"excludes",{get:function(){return this._excludes},set:function(e){e&&(this._excludes=e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"items",{get:function(){return this._cached},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"count",{get:function(){return this._cached.length},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"change",{get:function(){return this._cachedChange.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"title",{set:function(e){var t=this.curUrl;"string"==typeof e&&(e={text:e}),this._titleCached[t]=e,this.di("update current tag title: ",e),this._cachedChange.next({active:"title",title:e,list:this._cached})},enumerable:!0,configurable:!0}),e.prototype.index=function(t){return this._cached.findIndex(function(e){return e.url===t})},e.prototype.exists=function(e){return-1!==this.index(e)},e.prototype.get=function(t){return t&&this._cached.find(function(e){return e.url===t})||null},e.prototype.remove=function(e,t){var n="string"==typeof e?this.index(e):e,o=-1!==n?this._cached[n]:null;return!(!o||!t&&!o.closable)&&(this.destroy(o._handle),this._cached.splice(n,1),delete this._titleCached[e],!0)},e.prototype.close=function(e,t){return void 0===t&&(t=!1),this.removeUrlBuffer=e,this.remove(e,t),this._cachedChange.next({active:"close",url:e,list:this._cached}),this.di("close tag",e),!0},e.prototype.closeRight=function(e,t){void 0===t&&(t=!1);for(var n=this.index(e),o=this.count-1;n<o;o--)this.remove(o,t);return this.removeUrlBuffer=null,this._cachedChange.next({active:"closeRight",url:e,list:this._cached}),this.di("close right tages",e),!0},e.prototype.clear=function(t){var n=this;void 0===t&&(t=!1),this._cached.forEach(function(e){!t&&e.closable&&n.destroy(e._handle)}),this._cached=this._cached.filter(function(e){return!t&&!e.closable}),this.removeUrlBuffer=null,this._cachedChange.next({active:"clear",list:this._cached}),this.di("clear all catch")},e.prototype.move=function(t,e){var n=this._cached.findIndex(function(e){return e.url===t});if(-1!==n){var o=this._cached.slice();o.splice(e<0?o.length+e:e,0,o.splice(n,1)[0]),this._cached=o,this._cachedChange.next({active:"move",url:t,position:e,list:this._cached})}},e.prototype.replace=function(e){var t=this.curUrl;this.exists(t)?this.close(t,!0):this.removeUrlBuffer=t,this.injector.get(a.Router).navigateByUrl(e)},e.prototype.getTitle=function(e,t){if(this._titleCached[e])return this._titleCached[e];if(t&&t.data&&(t.data.titleI18n||t.data.title))return{text:t.data.title,i18n:t.data.titleI18n};var n=this.mode!==C.URL?this.getMenu(e):null;return n?{text:n.text,i18n:n.i18n}:{text:e}},e.prototype.clearTitleCached=function(){this._titleCached={}},Object.defineProperty(e.prototype,"closable",{set:function(e){var t=this.curUrl;this._closableCached[t]=e,this.di("update current tag closable: ",e),this._cachedChange.next({active:"closable",closable:e,list:this._cached})},enumerable:!0,configurable:!0}),e.prototype.getClosable=function(e,t){if("undefined"!=typeof this._closableCached[e])return this._closableCached[e];if(t&&t.data&&"boolean"==typeof t.data.reuseClosable)return t.data.reuseClosable;var n=this.mode!==C.URL?this.getMenu(e):null;return!n||"boolean"!=typeof n.reuseClosable||n.reuseClosable},e.prototype.clearClosableCached=function(){this._closableCached={}},e.prototype.getTruthRoute=function(e){for(var t=e;t.firstChild;)t=t.firstChild;return t},e.prototype.getUrl=function(e){for(var t=this.getTruthRoute(e),n=[];t;)n.push(t.url.join("/")),t=t.parent;return"/"+n.filter(function(e){return e}).reverse().join("/")},e.prototype.can=function(e){var t=this.getUrl(e);if(t===this.removeUrlBuffer)return!1;if(e.data&&"boolean"==typeof e.data.reuse)return e.data.reuse;if(this.mode===C.URL)return-1===this._excludes.findIndex(function(e){return e.test(t)});var n=this.getMenu(t);if(!n)return!1;if(this.mode===C.Menu){if(!1===n.reuse)return!1}else if(!n.reuse||!0!==n.reuse)return!1;return!0},e.prototype.refresh=function(e){this._cachedChange.next({active:"refresh",data:e})},e.prototype.destroy=function(e){e&&e.componentRef&&e.componentRef.destroy&&e.componentRef.destroy()},e.prototype.di=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.debug&&console.warn.apply(console,c(e))},e.prototype.getMenu=function(e){var t=this.menuService.getPathByUrl(e);return t&&0!==t.length?t.pop():null},e.prototype.runHook=function(e,t,n){n.instance&&"function"==typeof n.instance[e]&&n.instance[e]()},e.prototype.hasInValidRoute=function(e){return!e.routeConfig||e.routeConfig.loadChildren||e.routeConfig.children},e.prototype.shouldDetach=function(e){return!this.hasInValidRoute(e)&&(this.di("#shouldDetach",this.can(e),this.getUrl(e)),this.can(e))},e.prototype.store=function(e,t){var n=this.getUrl(e),o=this.index(n),i={title:this.getTitle(n,e),closable:this.getClosable(n,e),url:n,_snapshot:e,_handle:t};-1===o?(this._cached.push(i),this.count>this._max&&this._cached.shift()):this._cached[o]=i,this.removeUrlBuffer=null,this.di("#store",-1===o?"[new]":"[override]",n),t&&t.componentRef&&this.runHook("_onReuseDestroy",n,t.componentRef),this._cachedChange.next({active:"add",item:i,list:this._cached})},e.prototype.shouldAttach=function(e){if(this.hasInValidRoute(e))return!1;var t=this.getUrl(e),n=this.get(t),o=!(!n||!n._handle);return this.di("#shouldAttach",o,t),o&&n._handle.componentRef&&this.runHook("_onReuseInit",t,n._handle.componentRef),o},e.prototype.retrieve=function(e){if(this.hasInValidRoute(e))return null;var t=this.getUrl(e),n=this.get(t),o=n&&n._handle||null;return this.di("#retrieve",t,o),o},e.prototype.shouldReuseRoute=function(e,t){var n=e.routeConfig===t.routeConfig;if(!n)return!1;var o=e.routeConfig&&e.routeConfig.path||"";0<o.length&&~o.indexOf(":")&&(n=this.getUrl(e)===this.getUrl(t));return this.di("====================="),this.di("#shouldReuseRoute",n,this.getUrl(t)+"=>"+this.getUrl(e),e,t),n},e.prototype.ngOnDestroy=function(){this._cached=[],this._cachedChange.unsubscribe()},e.decorators=[{type:l.Injectable,args:[{providedIn:"root"}]}],e.ctorParameters=function(){return[{type:l.Injector},{type:t.MenuService}]},e.ngInjectableDef=l.defineInjectable({factory:function(){return new e(l.inject(l.INJECTOR),l.inject(t.MenuService))},token:e,providedIn:"root"}),e}(),_=function(){function e(e,t,n,o,i,r,s){var c=this;this.srv=t,this.cd=n,this.router=o,this.route=i,this.render=r,this.i18nSrv=s,this.list=[],this.pos=0,this.mode=C.Menu,this.debug=!1,this.allowClose=!0,this.showCurrent=!0,this.change=new l.EventEmitter,this.close=new l.EventEmitter,this.el=e.nativeElement;var u=this.router.events.pipe(f.filter(function(e){return e instanceof a.NavigationEnd}));this.sub$=d.combineLatest(this.srv.change,u).subscribe(function(e){var t=v(e,2),n=t[0];t[1];return c.genList(n)}),this.i18nSrv&&(this.i18n$=this.i18nSrv.change.pipe(f.debounceTime(100)).subscribe(function(){return c.genList()}))}return e.prototype.genTit=function(e){return e.i18n&&this.i18nSrv?this.i18nSrv.fanyi(e.i18n):e.text},e.prototype.genList=function(t){var n=this,e=t&&"close"===t.active,o=e?this.list.findIndex(function(e){return e.url===t.url}):-1,i=this.srv.items.map(function(e,t){return{url:e.url,title:n.genTit(e.title),closable:n.allowClose&&e.closable&&0<n.srv.count,index:t,active:!1,last:!1}});if(this.showCurrent){var r=this.route.snapshot,s=this.srv.getUrl(r),c=i.findIndex(function(e){return e.url===s});if(-1!==c||e&&t.url===s)this.pos=e?o<=c?this.pos-1:this.pos:c;else{var u=this.srv.getTruthRoute(r);i.push({url:s,title:this.genTit(this.srv.getTitle(s,u)),closable:this.allowClose&&0<this.srv.count&&this.srv.getClosable(s,u),index:i.length,active:!1,last:!1}),this.pos=i.length-1}i.length<=1&&(i[0].closable=!1)}(this.list=i).length&&e&&this.to(null,this.pos),this.refStatus(!1),this.visibility(),this.cd.detectChanges()},e.prototype.visibility=function(){this.showCurrent||this.render.setStyle(this.el,"display",0===this.list.length?"none":"block")},e.prototype.cmChange=function(e){switch(e.type){case"close":this._close(null,e.item.index,e.includeNonCloseable);break;case"closeRight":this.srv.closeRight(e.item.url,e.includeNonCloseable),this.close.emit(null);break;case"clear":case"closeOther":this.srv.clear(e.includeNonCloseable),this.close.emit(null)}},e.prototype.refStatus=function(e){var n=this;void 0===e&&(e=!0),this.list.length&&(this.list[this.list.length-1].last=!0,this.list.forEach(function(e,t){return e.active=n.pos===t})),e&&this.cd.detectChanges()},e.prototype.to=function(e,t){var n=this;e&&(e.preventDefault(),e.stopPropagation()),t=Math.max(0,Math.min(t,this.list.length-1));var o=this.list[t];this.router.navigateByUrl(o.url).then(function(e){e&&(n.pos=t,n.item=o,n.refStatus(),n.change.emit(o))})},e.prototype._close=function(e,t,n){e&&(e.preventDefault(),e.stopPropagation());var o=this.list[t];return this.srv.close(o.url,n),this.close.emit(o),this.cd.detectChanges(),!1},e.prototype.ngOnInit=function(){this.genList()},e.prototype.ngOnChanges=function(e){e.max&&(this.srv.max=this.max),e.excludes&&(this.srv.excludes=this.excludes),e.mode&&(this.srv.mode=this.mode),this.srv.debug=this.debug,this.cd.detectChanges()},e.prototype.ngOnDestroy=function(){var e=this.i18n$;this.sub$.unsubscribe(),e&&e.unsubscribe()},e.decorators=[{type:l.Component,args:[{selector:"reuse-tab",template:'<nz-tabset [nzSelectedIndex]="pos" [nzAnimated]="false" nzType="line">\n  <nz-tab *ngFor="let i of list; let index = index" [nzTitle]="titleTemplate">\n    <ng-template #titleTemplate>\n      <span [reuse-tab-context-menu]="i" (click)="to($event, index)" class="name">{{i.title}}</span>\n      <i *ngIf="i.closable" class="anticon anticon-close op" (click)="_close($event, index, false)"></i>\n    </ng-template>\n  </nz-tab>\n</nz-tabset>\n<reuse-tab-context [i18n]="i18n" (change)="cmChange($event)"></reuse-tab-context>\n',changeDetection:l.ChangeDetectionStrategy.OnPush,preserveWhitespaces:!1,providers:[u],host:{"[class.reuse-tab]":"true"}}]}],e.ctorParameters=function(){return[{type:l.ElementRef},{type:x},{type:l.ChangeDetectorRef},{type:a.Router},{type:a.ActivatedRoute},{type:l.Renderer2},{type:undefined,decorators:[{type:l.Optional},{type:l.Inject,args:[t.ALAIN_I18N_TOKEN]}]}]},e.propDecorators={mode:[{type:l.Input}],i18n:[{type:l.Input}],debug:[{type:l.Input}],max:[{type:l.Input}],excludes:[{type:l.Input}],allowClose:[{type:l.Input}],showCurrent:[{type:l.Input}],change:[{type:l.Output}],close:[{type:l.Output}]},r([n.InputBoolean(),s("design:type",Object)],e.prototype,"debug",void 0),r([n.InputNumber(),s("design:type",Number)],e.prototype,"max",void 0),r([n.InputBoolean(),s("design:type",Object)],e.prototype,"allowClose",void 0),r([n.InputBoolean(),s("design:type",Object)],e.prototype,"showCurrent",void 0),e}(),R=function(){function e(e){this.srv=e}return e.prototype.shouldDetach=function(e){return this.srv.shouldDetach(e)},e.prototype.store=function(e,t){this.srv.store(e,t)},e.prototype.shouldAttach=function(e){return this.srv.shouldAttach(e)},e.prototype.retrieve=function(e){return this.srv.retrieve(e)},e.prototype.shouldReuseRoute=function(e,t){return this.srv.shouldReuseRoute(e,t)},e}(),j=[_],O=[g,b,m],I=function(){function e(){}return e.forRoot=function(){return{ngModule:e}},e.decorators=[{type:l.NgModule,args:[{imports:[o.CommonModule,a.RouterModule,t.DelonLocaleModule,i.NgZorroAntdModule,h.OverlayModule],declarations:c(j,O),entryComponents:[g],exports:c(j)}]}],e}();e.ReuseTabContextMenuComponent=g,e.ReuseTabContextComponent=b,e.ReuseTabContextDirective=m,e.ReuseTabContextService=u,e.ReuseTabComponent=_,e.ReuseTabService=x,e.ReuseTabStrategy=R,e.ReuseTabModule=I,e.ReuseTabMatchMode=C,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=reuseTab.umd.min.js.map